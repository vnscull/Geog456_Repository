<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tornado Outbreaks East of the Rockies</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(to bottom, #a8e6cf, #ffffff); /* Gradient from light green to white */
        }
        #map {
            height: 500px;
            margin-bottom: 20px;
        }
        #DateTime {
            font-size: 18px;
            margin-bottom: 10px;
            text-align: center;
        }
        .slider {
            width: 80%;
            margin: 0 auto;
            display: block;
            background-color: #6495ED;
            border: none; 
            outline: none;
            border-radius: 10px;
            margin-bottom: 10px;
        }
        .slider::-webkit-slider-thumb {
            width: 20px;
            height: 20px;
            background-color: #fff;
            border-radius: 50%;
            cursor: pointer;
        }
        h1 {
            text-align: center;
            margin-top: 20px;
            margin-bottom: 10px;
        }
        h3 {
            text-align: center;
            margin-top: 10px;
            margin-bottom: 10px;
        }
        #sliderControl {
            text-align: center;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <h1>Tornado Outbreaks East of the Rockies</h1>
    <h3 id="DateTime">Date and Time</h3>
    <div id="sliderControl">
        <label><input type="checkbox" id="yearToggle" checked> Year</label>
        <label><input type="checkbox" id="monthToggle" checked> Month</label>
        <label><input type="checkbox" id="weekToggle" checked> Week</label>
        <label><input type="checkbox" id="dayToggle" checked> Day</label>
        <label><input type="checkbox" id="hourToggle" checked> Hour</label>
    </div>
    <input type="range" name="Year" id="yearSlider" class="slider" min="1973" max="2023" value="1973" oninput="moveYearSlider(this.value)">
    <input type="range" name="Month" id="monthSlider" class="slider" min="1" max="12" value="1" oninput="moveMonthSlider(this.value)">
    <input type="range" name="Week" id="weekSlider" class="slider" min="1" max="53" value="1" oninput="moveWeekSlider(this.value)">
    <input type="range" name="Day" id="daySlider" class="slider" min="1" max="31" value="1" oninput="moveDaySlider(this.value)">
    <input type="range" name="Hour" id="hourSlider" class="slider" min="0" max="23" value="0" oninput="moveHourSlider(this.value)">
    <div id="map"></div>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="./data/tornadoes.js"></script>
    <script>
        var map = L.map('map').setView([37.0902, -95.7129], 4); // Centering on USA

        var OSM = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);

        var Esri_WorldImagery = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
        });

        // Function to get color based on outbreak type
        function getColor(outbreakType) {
            return outbreakType === "1" ? 'blue' : 'pink';
        }

        // Creating separate GeoJSON layers for blue and pink outbreaks
        var Outbreaks = L.geoJSON(null, {
            pointToLayer: function (feature, latlng) {
                var outbreakType = feature.properties.outbreak;
                if (outbreakType === "1") {
                    return L.circleMarker(latlng, {
                        radius: 8,
                        fillColor: 'blue',
                        color: "#000",
                        weight: 1,
                        opacity: 1,
                        fillOpacity: 0.8
                    });
                }
            },
            onEachFeature: onEachFeature
        });

        var NonOutbreaks = L.geoJSON(null, {
            pointToLayer: function (feature, latlng) {
                var outbreakType = feature.properties.outbreak;
                if (outbreakType !== "1") {
                    return L.circleMarker(latlng, {
                        radius: 8,
                        fillColor: 'pink',
                        color: "#000",
                        weight: 1,
                        opacity: 1,
                        fillOpacity: 0.8
                    });
                }
            },
            onEachFeature: onEachFeature
        });

        // Adding blue and pink outbreaks to map
        Outbreaks.addTo(map);
        NonOutbreaks.addTo(map);

        // Setting up sliders
        var yearSlider = document.getElementById('yearSlider');
        var monthSlider = document.getElementById('monthSlider');
        var weekSlider = document.getElementById('weekSlider');
        var daySlider = document.getElementById('daySlider');
        var hourSlider = document.getElementById('hourSlider');

        // Checkbox toggles
        var yearToggle = document.getElementById('yearToggle');
        var monthToggle = document.getElementById('monthToggle');
        var weekToggle = document.getElementById('weekToggle');
        var dayToggle = document.getElementById('dayToggle');
        var hourToggle = document.getElementById('hourToggle');

        // Event listeners for toggle buttons
        yearToggle.addEventListener('change', toggleSlider);
        monthToggle.addEventListener('change', toggleSlider);
        weekToggle.addEventListener('change', toggleSlider);
        dayToggle.addEventListener('change', toggleSlider);
        hourToggle.addEventListener('change', toggleSlider);

        // Function to toggle slider visibility based on checkbox state
        function toggleSlider() {
            yearSlider.style.display = yearToggle.checked ? 'block' : 'none';
            monthSlider.style.display = monthToggle.checked ? 'block' : 'none';
            weekSlider.style.display = weekToggle.checked ? 'block' : 'none';
            daySlider.style.display = dayToggle.checked ? 'block' : 'none';
            hourSlider.style.display = hourToggle.checked ? 'block' : 'none';
            updateLayer();
        }

// Function to update layer based on slider values
function updateLayer() {
    var selectedYear = yearToggle.checked ? yearSlider.value : '';
    var selectedMonth = monthToggle.checked ? monthSlider.value : '';
    var selectedWeek = weekToggle.checked ? weekSlider.value : '';
    var selectedDay = dayToggle.checked ? daySlider.value : '';
    var selectedHour = hourToggle.checked ? hourSlider.value : '';
    
    var filteredData = tornadoes.features.filter(function(feature) {
        var featureYear = new Date(feature.properties.date_time).getUTCFullYear();
        var featureMonth = new Date(feature.properties.date_time).getUTCMonth() + 1; // Months are zero-based
        var featureWeek = getWeekNumber(new Date(feature.properties.date_time));
        var featureDay = new Date(feature.properties.date_time).getUTCDate();
        var featureHour = new Date(feature.properties.date_time).getUTCHours();
        
        return (!selectedYear || featureYear == selectedYear) &&
               (!selectedMonth || featureMonth == selectedMonth) &&
               (!selectedWeek || featureWeek == selectedWeek) &&
               (!selectedDay || featureDay == selectedDay) &&
               (!selectedHour || featureHour == selectedHour);
    });

    Outbreaks.clearLayers(); // Clear existing layer
    NonOutbreaks.clearLayers(); // Clear existing layer

    filteredData.forEach(function(feature) {
        var outbreakType = feature.properties.outbreak;
        if (outbreakType === "1") {
            Outbreaks.addData(feature);
        } else {
            NonOutbreaks.addData(feature);
        }
    });
}


        // Function to handle popup for each feature
        function onEachFeature(feature, layer) {
            if (feature.properties) {
                var popupContent = "<b>Time:</b> " + feature.properties.time + "<br>" +
                                   "<b>Fatalities:</b> " + feature.properties.fat + "<br>" +
                                   "<b>Adjusted Fujita Miles:</b> " + feature.properties.AFM + "<br>" +
                                   "<b>Date:</b> " + feature.properties.date;
                layer.bindPopup(popupContent);
            }
        }

        // Function to get the week number for a given date
        function getWeekNumber(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            var yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            var weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            return weekNo;
        }

        // Base maps and overlay maps
        var baseMaps = {
            "OpenStreetMap": OSM,
            "Esri": Esri_WorldImagery
        };

        var overlayMaps = {
            "Non-Outbreak": NonOutbreaks,
            "Outbreaks": Outbreaks
        };

        // Adding layer control
        L.control.layers(baseMaps, overlayMaps).addTo(map);
    </script>
</body>
</html>

